(window.webpackJsonp=window.webpackJsonp||[]).push([[81],{438:function(a,e,s){"use strict";s.r(e);var t=s(19),n=Object(t.a)({},(function(){var a=this,e=a._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"示例-数据缓存亲和性调度"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#示例-数据缓存亲和性调度"}},[a._v("#")]),a._v(" 示例 - 数据缓存亲和性调度")]),a._v(" "),e("p",[a._v("在Fluid中，"),e("code",[a._v("Dataset")]),a._v("资源对象中所定义的远程文件是可被调度的，这意味着你能够像管理你的Pod一样管理远程文件缓存在Kubernetes集群上的存放位置。")]),a._v(" "),e("p",[a._v("本文档将向你简单地展示上述特性")]),a._v(" "),e("h2",{attrs:{id:"前提条件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前提条件"}},[a._v("#")]),a._v(" 前提条件")]),a._v(" "),e("p",[a._v("在运行该示例之前，请参考"),e("RouterLink",{attrs:{to:"/zh/guide/install.html"}},[a._v("安装文档")]),a._v("完成安装，并检查Fluid各组件正常运行：")],1),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl get pod -n fluid-system\nalluxioruntime-controller-5b64fdbbb-84pc6   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          8h\ncsi-nodeplugin-fluid-fwgjh                  "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          8h\ncsi-nodeplugin-fluid-ll8bq                  "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          8h\ndataset-controller-5b7848dbbb-n44dj         "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          8h\n")])])]),e("p",[a._v("通常来说，你会看到一个名为"),e("code",[a._v("dataset-controller")]),a._v("的Pod、一个名为"),e("code",[a._v("alluxioruntime-controller")]),a._v("的Pod和多个名为"),e("code",[a._v("csi-nodeplugin")]),a._v("的Pod正在运行。其中，"),e("code",[a._v("csi-nodeplugin")]),a._v("这些Pod的数量取决于你的Kubernetes集群中结点的数量。")]),a._v(" "),e("h2",{attrs:{id:"新建工作环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#新建工作环境"}},[a._v("#")]),a._v(" 新建工作环境")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("any-path"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("/co-locality\n$ "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("any-path"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("/co-locality\n")])])]),e("h2",{attrs:{id:"运行示例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#运行示例"}},[a._v("#")]),a._v(" 运行示例")]),a._v(" "),e("p",[e("strong",[a._v("查看全部结点")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl get nodes\nNAME                       STATUS   ROLES    AGE     VERSION\ncn-beijing.192.168.1.146   Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("   7d14h   v1.16.9-aliyun.1\ncn-beijing.192.168.1.147   Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("   7d14h   v1.16.9-aliyun.1\n")])])]),e("p",[e("strong",[a._v("使用标签标识结点")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl label nodes cn-beijing.192.168.1.146 hbase-cache"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true\n")])])]),e("p",[a._v("在接下来的步骤中，我们将使用"),e("code",[a._v("NodeSelector")]),a._v("来管理集群中存放数据的位置，所以在这里标记期望的结点")]),a._v(" "),e("p",[e("strong",[a._v("再次查看结点")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl get "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" -L hbase-cache\nNAME                       STATUS   ROLES    AGE     VERSION            HBASE-CACHE\ncn-beijing.192.168.1.146   Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("   7d14h   v1.16.9-aliyun.1   "),e("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\ncn-beijing.192.168.1.147   Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("   7d14h   v1.16.9-aliyun.1   \n")])])]),e("p",[a._v("目前，在全部2个结点中，仅有一个结点添加了"),e("code",[a._v("hbase-cache=true")]),a._v("的标签，接下来，我们希望数据缓存仅会被放置在该结点之上")]),a._v(" "),e("p",[e("strong",[a._v("检查待创建的Dataset资源对象")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ cat"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),e("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOF"),e("span",{pre:!0,attrs:{class:"token bash punctuation"}},[a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("dataset.yaml")]),a._v('\napiVersion: data.fluid.io/v1alpha1\nkind: Dataset\nmetadata:\n  name: hbase\nspec:\n  mounts:\n    - mountPoint: https://mirrors.tuna.tsinghua.edu.cn/apache/hbase/stable/\n      name: hbase\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n        - matchExpressions:\n            - key: hbase-cache\n              operator: In\n              values:\n                - "true"\nEOF')]),a._v("\n")])])]),e("p",[a._v("在该"),e("code",[a._v("Dataset")]),a._v("资源对象的"),e("code",[a._v("spec")]),a._v("属性中，我们定义了一个"),e("code",[a._v("nodeSelectorTerm")]),a._v("的子属性，该子属性要求数据缓存必须被放置在具有"),e("code",[a._v("hbase-cache=true")]),a._v("标签的结点之上")]),a._v(" "),e("p",[e("strong",[a._v("创建Dataset资源对象")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl create -f dataset.yaml\ndataset.data.fluid.io/hbase created\n")])])]),e("p",[e("strong",[a._v("检查待创建的AlluxioRuntime资源对象")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ cat"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),e("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOF"),e("span",{pre:!0,attrs:{class:"token bash punctuation"}},[a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("runtime.yaml")]),a._v('\napiVersion: data.fluid.io/v1alpha1\nkind: AlluxioRuntime\nmetadata:\n  name: hbase\nspec:\n  replicas: 2\n  tieredstore:\n    levels:\n      - mediumtype: MEM\n        path: /dev/shm\n        quota: 2Gi\n        high: "0.95"\n        low: "0.7"\nEOF')]),a._v("\n")])])]),e("p",[a._v("该配置文件片段中，包含了许多与Alluxio相关的配置信息，这些信息将被Fluid用来启动一个Alluxio实例。上述配置片段中的"),e("code",[a._v("spec.replicas")]),a._v("属性被设置为2,这表明Fluid将会启动一个包含1个Alluxio Master和2个Alluxio Worker的Alluxio实例")]),a._v(" "),e("p",[e("strong",[a._v("创建AlluxioRuntime资源并查看状态")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl create -f runtime.yaml\nalluxioruntime.data.fluid.io/hbase created\n\n$ kubectl get pod -o wide\nNAME                 READY   STATUS    RESTARTS   AGE    IP              NODE                       NOMINATED NODE   READINESS GATES\nhbase-master-0       "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          3m3s   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.147   cn-beijing.192.168.1.147   "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\nhbase-worker-0       "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          104s   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.146   cn-beijing.192.168.1.146   "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\nhbase-worker-1       "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("/2     Pending   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          104s   "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("          "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("                     "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])]),e("p",[a._v("在此处可以看到，尽管我们期望看见两个AlluxioWorker被启动，但仅有一个Alluxio Worker Pod成功被调度，并且运行在具有指定标签（即"),e("code",[a._v("hbase-cache=true")]),a._v("）的结点之上。")]),a._v(" "),e("p",[e("strong",[a._v("检查AlluxioRuntime状态")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl get alluxioruntime hbase -o wide\nNAME    READY MASTERS   DESIRED MASTERS   MASTER PHASE   READY WORKERS   DESIRED WORKERS   WORKER PHASE   READY FUSES   DESIRED FUSES   FUSE PHASE     AGE\nhbase   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("               "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("                 Ready          "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("               "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("                 PartialReady   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("             "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("               Ready          4m3s\n")])])]),e("p",[a._v("与预想一致，"),e("code",[a._v("Worker Phase")]),a._v("状态此时为"),e("code",[a._v("PartialReady")]),a._v("，并且"),e("code",[a._v("Ready Workers: 1")]),a._v("小于"),e("code",[a._v("Desired Workers: 2")])]),a._v(" "),e("p",[e("strong",[a._v("为另一个结点添加标签")])]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl label "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" cn-beijing.192.168.1.147 hbase-cache"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true\n")])])]),e("p",[a._v("现在全部两个结点都具有相同的标签了，此时重新检查各个组件的运行状态")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl get pod -o wide\nNAME                 READY   STATUS    RESTARTS   AGE   IP              NODE                       NOMINATED NODE   READINESS GATES\nhbase-master-0       "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          46m   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.147   cn-beijing.192.168.1.147   "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\nhbase-worker-0       "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          44m   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.146   cn-beijing.192.168.1.146   "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\nhbase-worker-1       "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("          44m   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.147   cn-beijing.192.168.1.147   "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])]),e("p",[a._v("两个Alluxio Worker都成功启动，并且分别运行在两个结点上")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl get alluxioruntime hbase -o wide\nNAME    READY MASTERS   DESIRED MASTERS   MASTER PHASE   READY WORKERS   DESIRED WORKERS   WORKER PHASE   READY FUSES   DESIRED FUSES   FUSE PHASE   AGE\nhbase   "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("               "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("                 Ready          "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("               "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("                 Ready          "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("             "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("               Ready        46m43s\n")])])]),e("p",[a._v("可见，Fluid将数据缓存视作Kubernetes可调度的资源，支持数据缓存的调度策略,这些调度策略为用户提供了更加灵活的数据缓存管理能力。")]),a._v(" "),e("h2",{attrs:{id:"环境清理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#环境清理"}},[a._v("#")]),a._v(" 环境清理")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[a._v("$ kubectl delete -f "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n\n$ kubectl label "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" cn-beijing.192.168.1.146 hbase-cache-\n$ kubectl label "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" cn-beijing.192.168.1.147 hbase-cache-\n")])])])])}),[],!1,null,null,null);e.default=n.exports}}]);